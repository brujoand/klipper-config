#####################################################################
#   Nozzle Clean and Purge Bucket
#####################################################################
[gcode_macro CLEAN_NOZZLE]
variable_start_x: 85
variable_start_y: 304
variable_start_z: 10
variable_wipe_dist: 55
variable_wipe_qty: 2
variable_wipe_spd: 50
variable_raise_distance: 20
variable_zig_depth: 2
variable_zig_width: 5
variable_zig_spd: 30
variable_zig_qty: 2

gcode:
 {% if "xyz" not in printer.toolhead.homed_axes %}
   G28
 {% endif %}

 G90                                            ; absolute positioning
 ## Move nozzle to start position
 G1 Y290 F6000 # Safe distance
 G1 X{start_x} F6000
 G1 Y{start_y} F6000
 G1 Z{start_z} F1500

 ## ZigZag Wipe nozzle
 {% set zig_steps = (wipe_dist // zig_width )|int %}

 {% for zig in range(1, (zig_qty + 1)) %}
   {% if zig % 2 == 0 %}
     {% set zig_direction = -1 %}
     {% set relative_x_start = (start_x + wipe_dist ) %}
   {% else %}
     {% set zig_direction = 1 %}
     {% set relative_x_start = start_x %}
   {% endif %}

   {% for step in range(1, (zig_steps + 1)) %}

     {% if step % 2 == 0 %}
       {% set zag_direction = 0 %}
     {% else %}
       # Only go down, never up above starting point
       {% set zag_direction = -1 %}
     {% endif %}

     {% set zig_x_step = ((step * zig_width) * zig_direction) %}
     {% set zig_y_step = (zig_depth * zag_direction) %}
     G1 X{relative_x_start + zig_x_step} Y{start_y + zig_y_step} F{zig_spd * 60}

   {% endfor %}

   # Return to start_y position after each pass to reset for the next pass
   G1 Y{start_y} F{zig_spd * 60}
 {% endfor %}

 ## Move back to start position
 G1 X{start_x} Y{start_y} F6000

 ## Wipe nozzle
 {% for wipes in range(1, (wipe_qty + 1)) %}
   G1 X{start_x + wipe_dist} F{wipe_spd * 60}
   G1 X{start_x} F{wipe_spd * 60}
 {% endfor %}

 ## Raise nozzle
 G1 Z{raise_distance}
 G1 Y250 F6000 # Safe distance

# Macro to dump all defined variablels
[gcode_macro DUMP_VARIABLES]
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}

    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}

    {action_respond_info(out|join("\n"))}


[gcode_macro M141]
gcode:
    {% set s = params.S|default(0)|float %}
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={s}
